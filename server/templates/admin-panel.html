<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TransportGo Admin</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0A1628;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;line-height:1.6}
input,button,select{font-family:inherit}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
.login-card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:40px;width:100%;max-width:400px;animation:fadeInScale 0.5s ease forwards}
@keyframes fadeInScale{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
.login-card h1{font-size:24px;font-weight:700;margin-bottom:8px;text-align:center}
.login-card p{color:rgba(255,255,255,0.5);font-size:14px;margin-bottom:32px;text-align:center}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:13px;font-weight:600;color:rgba(255,255,255,0.7);margin-bottom:6px}
.form-group input{width:100%;padding:12px 16px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:10px;color:#fff;font-size:15px;outline:none;transition:border-color 0.2s}
.form-group input:focus{border-color:#1B6EF3}
.btn{width:100%;padding:12px;background:linear-gradient(135deg,#1B6EF3,#0050D0);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:opacity 0.2s}
.btn:hover{opacity:0.9}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.error-msg{background:rgba(239,68,68,0.15);color:#f87171;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none}
.app-wrap{display:none;height:100vh;overflow:hidden}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;background:rgba(255,255,255,0.03);border-right:1px solid rgba(255,255,255,0.06);padding:20px 0;display:flex;flex-direction:column;z-index:50}
.sidebar-logo{padding:0 20px 24px;font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:8px}
.sidebar-logo svg{width:28px;height:28px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 20px;font-size:14px;font-weight:500;color:rgba(255,255,255,0.6);cursor:pointer;transition:all 0.2s;border-left:3px solid transparent;position:relative;overflow:hidden}
.nav-item::before{content:'';position:absolute;left:0;top:0;width:100%;height:100%;background:rgba(255,255,255,0.04);transform:translateX(-100%);transition:transform 0.3s ease}
.nav-item:hover::before{transform:translateX(0)}
.nav-item:hover{color:#fff}
.nav-item.active{color:#1B6EF3;background:rgba(27,110,243,0.08);border-left-color:#1B6EF3}
.nav-item svg{width:20px;height:20px;flex-shrink:0}
.sidebar-bottom{margin-top:auto;padding:16px 20px;border-top:1px solid rgba(255,255,255,0.06)}
.back-link{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer;transition:color 0.2s}
.back-link:hover{color:#00C9A7}
.main{margin-left:240px;height:100vh;display:flex;flex-direction:column}
.topbar{height:64px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:space-between;padding:0 28px;background:rgba(10,22,40,0.95);backdrop-filter:blur(12px);flex-shrink:0}
.topbar h2{font-size:16px;font-weight:600}
.logout-btn{background:rgba(239,68,68,0.15);color:#f87171;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:background 0.2s}
.logout-btn:hover{background:rgba(239,68,68,0.25)}
.content{flex:1;overflow-y:auto;padding:28px}
.tab-content{display:none}
.tab-content.active{display:block}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}
.stat-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:24px}
.stat-card .label{font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:8px}
.stat-card .value{font-size:28px;font-weight:700}
.stat-card .value.blue{color:#1B6EF3}
.stat-card .value.teal{color:#00C9A7}
.stat-card .value.purple{color:#8B5CF6}
.stat-card .value.amber{color:#F59E0B}
table{width:100%;border-collapse:collapse;background:rgba(255,255,255,0.02);border-radius:12px;overflow:hidden}
thead{background:rgba(255,255,255,0.04)}
th{text-align:left;padding:14px 16px;font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.5px}
td{padding:14px 16px;font-size:14px;border-top:1px solid rgba(255,255,255,0.04)}
tbody tr{transition:all 0.25s ease;position:relative}
tbody tr:hover{background:rgba(27,110,243,0.06);transform:translateX(4px)}
.badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}
.badge-green{background:rgba(34,197,94,0.15);color:#4ade80}
.badge-yellow{background:rgba(245,158,11,0.15);color:#fbbf24}
.badge-red{background:rgba(239,68,68,0.15);color:#f87171}
.badge-blue{background:rgba(27,110,243,0.15);color:#60a5fa}
.badge-gray{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6)}
.action-btn{padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all 0.2s ease;margin-right:4px}
.action-btn:hover{transform:scale(1.05);box-shadow:0 0 12px rgba(255,255,255,0.1)}
.action-btn.approve{background:rgba(34,197,94,0.15);color:#4ade80}
.action-btn.delete{background:rgba(239,68,68,0.15);color:#f87171}
.action-btn.save{background:rgba(27,110,243,0.15);color:#60a5fa}
.vehicles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
.vehicle-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:24px}
.vehicle-card h3{font-size:18px;font-weight:600;margin-bottom:4px}
.vehicle-card .vehicle-type{font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:16px}
.vehicle-card .field{margin-bottom:12px}
.vehicle-card .field label{display:block;font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px}
.vehicle-card .field input{width:100%;padding:8px 12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:8px;color:#fff;font-size:14px;outline:none}
.vehicle-card .field input:focus{border-color:#1B6EF3}
.drivers-list{display:grid;gap:12px}
.driver-item{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px 20px}
.driver-info h4{font-size:15px;font-weight:600}
.driver-info p{font-size:13px;color:rgba(255,255,255,0.5)}
.online-dot{width:10px;height:10px;border-radius:50%;background:#4ade80;flex-shrink:0}
.loading{text-align:center;padding:40px;color:rgba(255,255,255,0.4);font-size:14px;display:flex;align-items:center;justify-content:center;gap:12px}
.loading::before{content:'';width:20px;height:20px;border:2px solid rgba(255,255,255,0.1);border-top-color:rgba(255,255,255,0.5);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:rgba(255,255,255,0.3);font-size:14px}
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:500;z-index:1000;opacity:0;transform:translateX(100px)}
.toast.show{animation:slideInRight 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards}
.toast.hide{animation:slideOutRight 0.3s ease forwards}
@keyframes slideInRight{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideOutRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100px)}}
.toast.success{background:rgba(34,197,94,0.9);color:#fff}
.toast.error{background:rgba(239,68,68,0.9);color:#fff}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.section-header h3{font-size:20px;font-weight:600}
.refresh-btn{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.7);border:none;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer;transition:background 0.2s}
.refresh-btn:hover{background:rgba(255,255,255,0.12)}
.tab-content.active{display:block}
.tab-content.fade-in{animation:fadeInTab 0.3s ease forwards}
@keyframes fadeInTab{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.stat-card{opacity:0;animation:fadeInUp 0.4s ease forwards}
.stat-card:nth-child(1){animation-delay:0s}
.stat-card:nth-child(2){animation-delay:0.1s}
.stat-card:nth-child(3){animation-delay:0.2s}
.stat-card:nth-child(4){animation-delay:0.3s}
@keyframes countUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.stat-card .value{animation:countUp 0.5s ease forwards;animation-delay:0.2s}
.stat-card:nth-child(2) .value{animation-delay:0.3s}
.stat-card:nth-child(3) .value{animation-delay:0.4s}
.stat-card:nth-child(4) .value{animation-delay:0.5s}
.vehicle-card{transition:transform 0.2s ease,box-shadow 0.2s ease}
.vehicle-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.2)}
.driver-item{transition:transform 0.2s ease,background 0.2s ease}
.driver-item:hover{transform:translateX(4px);background:rgba(255,255,255,0.06)}
.btn{transition:all 0.2s ease}
.btn:hover{opacity:0.9;transform:scale(1.02);box-shadow:0 0 20px rgba(27,110,243,0.3)}
@media(max-width:768px){
.sidebar{width:60px}
.sidebar-logo span,.nav-item span,.sidebar-bottom{display:none}
.nav-item{justify-content:center;padding:14px 0;border-left:none;border-bottom:3px solid transparent}
.nav-item.active{border-bottom-color:#1B6EF3;border-left-color:transparent}
.main{margin-left:60px}
.stats-grid{grid-template-columns:repeat(2,1fr)}
.topbar h2{font-size:14px}
.content{padding:16px}
table{font-size:12px}
th,td{padding:10px 8px}
}
</style>
</head>
<body>
<div id="loginView" class="login-wrap">
<div class="login-card">
<h1>TransportGo Admin</h1>
<p>Sign in to access the admin dashboard</p>
<div id="loginError" class="error-msg"></div>
<div class="form-group">
<label>Phone Number</label>
<input type="tel" id="loginPhone" value="9999999999">
</div>
<div class="form-group">
<label>Password</label>
<input type="password" id="loginPassword" value="admin123">
</div>
<button class="btn" id="loginBtn" onclick="handleLogin()">Sign In</button>
</div>
</div>

<div id="appView" class="app-wrap">
<aside class="sidebar">
<div class="sidebar-logo">
<svg viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="8" fill="#1B6EF3"/><path d="M4 14l2-6h12v6H4zm14-6h4l4 6h-8V8z" fill="#fff" fill-opacity="0.9"/><path d="M3 14h23v4H3v-4z" fill="#fff"/><circle cx="8" cy="21" r="2.5" fill="#0A1628" stroke="#fff" stroke-width="1.5"/><circle cx="22" cy="21" r="2.5" fill="#0A1628" stroke="#fff" stroke-width="1.5"/></svg>
<span>TransportGo</span>
</div>
<div class="nav-item active" onclick="switchTab('dashboard')" data-tab="dashboard">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
<span>Dashboard</span>
</div>
<div class="nav-item" onclick="switchTab('users')" data-tab="users">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
<span>Users</span>
</div>
<div class="nav-item" onclick="switchTab('bookings')" data-tab="bookings">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
<span>Bookings</span>
</div>
<div class="nav-item" onclick="switchTab('vehicles')" data-tab="vehicles">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
<span>Vehicles</span>
</div>
<div class="nav-item" onclick="switchTab('drivers')" data-tab="drivers">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
<span>Live Drivers</span>
</div>
<div class="sidebar-bottom">
<a href="/" class="back-link">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
Back to App
</a>
</div>
</aside>
<div class="main">
<div class="topbar">
<h2>TransportGo Admin</h2>
<button class="logout-btn" onclick="handleLogout()">Logout</button>
</div>
<div class="content">
<div id="tab-dashboard" class="tab-content active">
<div class="section-header"><h3>Dashboard</h3><button class="refresh-btn" onclick="loadStats()">Refresh</button></div>
<div id="statsGrid" class="stats-grid"><div class="loading">Loading stats...</div></div>
</div>
<div id="tab-users" class="tab-content">
<div class="section-header"><h3>Users</h3><button class="refresh-btn" onclick="loadUsers()">Refresh</button></div>
<div id="usersTable"><div class="loading">Loading users...</div></div>
</div>
<div id="tab-bookings" class="tab-content">
<div class="section-header"><h3>Bookings</h3><button class="refresh-btn" onclick="loadBookings()">Refresh</button></div>
<div id="bookingsTable"><div class="loading">Loading bookings...</div></div>
</div>
<div id="tab-vehicles" class="tab-content">
<div class="section-header"><h3>Vehicle Pricing</h3><button class="refresh-btn" onclick="loadVehicles()">Refresh</button></div>
<div id="vehiclesGrid"><div class="loading">Loading vehicles...</div></div>
</div>
<div id="tab-drivers" class="tab-content">
<div class="section-header"><h3>Live Drivers</h3><button class="refresh-btn" onclick="loadDrivers()">Refresh</button></div>
<div id="driversList"><div class="loading">Loading drivers...</div></div>
</div>
</div>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
var API = '';
var token = localStorage.getItem('admin_token');

if (token) showApp();

function getHeaders() {
  return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
}

function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type + ' show';
  setTimeout(function() {
    t.classList.remove('show');
    t.classList.add('hide');
    setTimeout(function() { t.className = 'toast'; }, 300);
  }, 3000);
}

function handleLogin() {
  var phone = document.getElementById('loginPhone').value;
  var password = document.getElementById('loginPassword').value;
  var btn = document.getElementById('loginBtn');
  var err = document.getElementById('loginError');
  btn.disabled = true;
  btn.textContent = 'Signing in...';
  err.style.display = 'none';
  fetch(API + '/api/auth/admin-login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone: phone, password: password })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    btn.disabled = false;
    btn.textContent = 'Sign In';
    if (data.error) {
      err.textContent = data.error;
      err.style.display = 'block';
      return;
    }
    token = data.token;
    localStorage.setItem('admin_token', token);
    showApp();
  })
  .catch(function(e) {
    btn.disabled = false;
    btn.textContent = 'Sign In';
    err.textContent = 'Connection failed. Please try again.';
    err.style.display = 'block';
  });
}

function handleLogout() {
  token = null;
  localStorage.removeItem('admin_token');
  document.getElementById('loginView').style.display = 'flex';
  document.getElementById('appView').style.display = 'none';
}

function showApp() {
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('appView').style.display = 'flex';
  loadStats();
}

function switchTab(tab) {
  var items = document.querySelectorAll('.nav-item');
  for (var i = 0; i < items.length; i++) {
    items[i].classList.toggle('active', items[i].getAttribute('data-tab') === tab);
  }
  var tabs = document.querySelectorAll('.tab-content');
  for (var i = 0; i < tabs.length; i++) {
    var isActive = tabs[i].id === 'tab-' + tab;
    tabs[i].classList.toggle('active', isActive);
    tabs[i].classList.remove('fade-in');
    if (isActive) {
      void tabs[i].offsetWidth;
      tabs[i].classList.add('fade-in');
    }
  }
  if (tab === 'dashboard') loadStats();
  if (tab === 'users') loadUsers();
  if (tab === 'bookings') loadBookings();
  if (tab === 'vehicles') loadVehicles();
  if (tab === 'drivers') loadDrivers();
}

function loadStats() {
  var el = document.getElementById('statsGrid');
  el.innerHTML = '<div class="loading">Loading stats...</div>';
  fetch(API + '/api/admin/stats', { headers: getHeaders() })
  .then(function(r) {
    if (r.status === 401) { handleLogout(); throw new Error('Unauthorized'); }
    return r.json();
  })
  .then(function(data) {
    el.innerHTML =
      '<div class="stat-card"><div class="label">Total Users</div><div class="value blue">' + (data.totalUsers || 0) + '</div></div>' +
      '<div class="stat-card"><div class="label">Total Bookings</div><div class="value teal">' + (data.totalBookings || 0) + '</div></div>' +
      '<div class="stat-card"><div class="label">Active Bookings</div><div class="value purple">' + (data.activeBookings || 0) + '</div></div>' +
      '<div class="stat-card"><div class="label">Revenue</div><div class="value amber">Rs. ' + (data.totalRevenue || 0) + '</div></div>';
  })
  .catch(function(e) {
    if (e.message !== 'Unauthorized') el.innerHTML = '<div class="empty">Failed to load stats</div>';
  });
}

function loadUsers() {
  var el = document.getElementById('usersTable');
  el.innerHTML = '<div class="loading">Loading users...</div>';
  fetch(API + '/api/admin/users', { headers: getHeaders() })
  .then(function(r) {
    if (r.status === 401) { handleLogout(); throw new Error('Unauthorized'); }
    return r.json();
  })
  .then(function(data) {
    var users = data.users || [];
    if (!users.length) { el.innerHTML = '<div class="empty">No users found</div>'; return; }
    var html = '<table><thead><tr><th>Name</th><th>Phone</th><th>Role</th><th>Status</th><th>Approved</th><th>Actions</th></tr></thead><tbody>';
    for (var i = 0; i < users.length; i++) {
      var u = users[i];
      var statusBadge = u.isOnline ? '<span class="badge badge-green">Online</span>' : '<span class="badge badge-gray">Offline</span>';
      var approvedBadge = u.isApproved ? '<span class="badge badge-green">Yes</span>' : '<span class="badge badge-yellow">Pending</span>';
      var actions = '';
      if (u.role === 'driver' && !u.isApproved) {
        actions += '<button class="action-btn approve" onclick="approveUser(\'' + u.id + '\')">Approve</button>';
      }
      actions += '<button class="action-btn delete" onclick="deleteUser(\'' + u.id + '\')">Delete</button>';
      html += '<tr><td>' + (u.name || '-') + '</td><td>' + u.phone + '</td><td><span class="badge badge-blue">' + u.role + '</span></td><td>' + statusBadge + '</td><td>' + approvedBadge + '</td><td>' + actions + '</td></tr>';
    }
    html += '</tbody></table>';
    el.innerHTML = html;
  })
  .catch(function(e) {
    if (e.message !== 'Unauthorized') el.innerHTML = '<div class="empty">Failed to load users</div>';
  });
}

function approveUser(id) {
  fetch(API + '/api/admin/users/' + id + '/approve', { method: 'PUT', headers: getHeaders() })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) { showToast(data.error, 'error'); return; }
    showToast('User approved', 'success');
    loadUsers();
  })
  .catch(function() { showToast('Failed to approve user', 'error'); });
}

function deleteUser(id) {
  if (!confirm('Are you sure you want to delete this user?')) return;
  fetch(API + '/api/admin/users/' + id, { method: 'DELETE', headers: getHeaders() })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) { showToast(data.error, 'error'); return; }
    showToast('User deleted', 'success');
    loadUsers();
  })
  .catch(function() { showToast('Failed to delete user', 'error'); });
}

function loadBookings() {
  var el = document.getElementById('bookingsTable');
  el.innerHTML = '<div class="loading">Loading bookings...</div>';
  fetch(API + '/api/admin/bookings', { headers: getHeaders() })
  .then(function(r) {
    if (r.status === 401) { handleLogout(); throw new Error('Unauthorized'); }
    return r.json();
  })
  .then(function(data) {
    var bookings = data.bookings || [];
    if (!bookings.length) { el.innerHTML = '<div class="empty">No bookings found</div>'; return; }
    var html = '<table><thead><tr><th>ID</th><th>Customer</th><th>Driver</th><th>Route</th><th>Vehicle</th><th>Price</th><th>Status</th><th>Date</th></tr></thead><tbody>';
    for (var i = 0; i < bookings.length; i++) {
      var b = bookings[i];
      var shortId = b.id.substring(0, 8);
      var route = (b.pickup ? b.pickup.area : '-') + ' to ' + (b.delivery ? b.delivery.area : '-');
      var statusClass = 'badge-gray';
      if (b.status === 'completed') statusClass = 'badge-green';
      else if (b.status === 'pending') statusClass = 'badge-yellow';
      else if (b.status === 'accepted' || b.status === 'in_progress') statusClass = 'badge-blue';
      else if (b.status === 'cancelled') statusClass = 'badge-red';
      var date = new Date(b.createdAt).toLocaleDateString();
      html += '<tr><td>' + shortId + '</td><td>' + (b.customerName || '-') + '</td><td>' + (b.driverName || '-') + '</td><td>' + route + '</td><td><span class="badge badge-blue">' + b.vehicleType + '</span></td><td>Rs. ' + b.totalPrice + '</td><td><span class="badge ' + statusClass + '">' + b.status + '</span></td><td>' + date + '</td></tr>';
    }
    html += '</tbody></table>';
    el.innerHTML = html;
  })
  .catch(function(e) {
    if (e.message !== 'Unauthorized') el.innerHTML = '<div class="empty">Failed to load bookings</div>';
  });
}

function loadVehicles() {
  var el = document.getElementById('vehiclesGrid');
  el.innerHTML = '<div class="loading">Loading vehicles...</div>';
  fetch(API + '/api/admin/vehicles', { headers: getHeaders() })
  .then(function(r) {
    if (r.status === 401) { handleLogout(); throw new Error('Unauthorized'); }
    return r.json();
  })
  .then(function(data) {
    var vehicles = data.vehicles || [];
    if (!vehicles.length) { el.innerHTML = '<div class="empty">No vehicles found</div>'; return; }
    var html = '<div class="vehicles-grid">';
    for (var i = 0; i < vehicles.length; i++) {
      var v = vehicles[i];
      html += '<div class="vehicle-card">' +
        '<h3>' + v.name + '</h3>' +
        '<div class="vehicle-type">' + v.type + ' - ' + v.capacity + '</div>' +
        '<div class="field"><label>Base Fare (Rs.)</label><input type="number" id="bf-' + v.id + '" value="' + v.baseFare + '"></div>' +
        '<div class="field"><label>Per KM Charge (Rs.)</label><input type="number" id="pk-' + v.id + '" value="' + v.perKmCharge + '"></div>' +
        '<button class="action-btn save" style="width:100%;padding:10px;margin-top:8px" onclick="saveVehicle(\'' + v.id + '\')">Save Changes</button>' +
        '</div>';
    }
    html += '</div>';
    el.innerHTML = html;
  })
  .catch(function(e) {
    if (e.message !== 'Unauthorized') el.innerHTML = '<div class="empty">Failed to load vehicles</div>';
  });
}

function saveVehicle(id) {
  var baseFare = parseFloat(document.getElementById('bf-' + id).value);
  var perKmCharge = parseFloat(document.getElementById('pk-' + id).value);
  fetch(API + '/api/admin/vehicles/' + id, {
    method: 'PUT',
    headers: getHeaders(),
    body: JSON.stringify({ baseFare: baseFare, perKmCharge: perKmCharge })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) { showToast(data.error, 'error'); return; }
    showToast('Vehicle pricing updated', 'success');
  })
  .catch(function() { showToast('Failed to update vehicle', 'error'); });
}

function loadDrivers() {
  var el = document.getElementById('driversList');
  el.innerHTML = '<div class="loading">Loading drivers...</div>';
  fetch(API + '/api/admin/drivers/online', { headers: getHeaders() })
  .then(function(r) {
    if (r.status === 401) { handleLogout(); throw new Error('Unauthorized'); }
    return r.json();
  })
  .then(function(data) {
    var drivers = data.drivers || [];
    if (!drivers.length) { el.innerHTML = '<div class="empty">No drivers currently online</div>'; return; }
    var html = '<div class="drivers-list">';
    for (var i = 0; i < drivers.length; i++) {
      var d = drivers[i];
      var loc = d.location ? d.location.lat.toFixed(4) + ', ' + d.location.lng.toFixed(4) : 'Unknown';
      html += '<div class="driver-item">' +
        '<div class="driver-info"><h4>' + (d.name || 'Unknown') + '</h4><p>' + (d.vehicleType || '-') + ' - ' + (d.vehicleNumber || '-') + ' | Location: ' + loc + '</p></div>' +
        '<div class="online-dot"></div>' +
        '</div>';
    }
    html += '</div>';
    el.innerHTML = html;
  })
  .catch(function(e) {
    if (e.message !== 'Unauthorized') el.innerHTML = '<div class="empty">Failed to load drivers</div>';
  });
}
</script>
</body>
</html>